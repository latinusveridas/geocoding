//DATE & TIME
var datetime = require('node-datetime');

////GEOCODER
var NodeGeocoder = require('node-geocoder');
var Options = {provider: 'openstreetmap'};
var geocoder = NodeGeocoder(Options);

//EXPRESS
var express = require('express');
var app = express();

//BODYPARSER
var bodyParser = require("body-parser");
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false }));

//DATES
var isoWeek = require('iso-week');
var dateModule = require('date-and-time');

// DB
var mysql = require('mysql');

//RANDOM STRING
var rdmString = require('randomstring');

// DEFINE POOLING
var pool_events = mysql.createPool({
    connectionLimit: 10,
    host: "83.217.132.102",
    port: '3306',
    user: "root",
    password: "Miroslava326356$$$$$",
    database: "events"
});

module.exports.pool_events = pool_events;

//Structure of the response
var resMain = {
    "error": 0,
    "error_description": "",
    "success" : "",
    "type_data" : "",
    "data" : {}
}

app.get('/collectevents', function (req,res) {

	var Code = "fr" // <--- Debug
	CollectEvents(Code).then(toBeSend => {
	res.status(200).json(toBeSend)
	})

});


app.get('/createevent', function (req,res) {

	var country_code_table = "fr" // <--- DEBUG

        var resMain = {
        "error": 0,
        "error_description": "",
        "success" : "",
        "type_data" : "",
        "data" : {}
    }
    
    // Define the variables    
    var sport = req.body.sport
    var organizer_id = req.body.organizer_id
    var price = req.body.price
    var part_max = req.body.part_max
    var date = req.body.date
    var addressStr = req.body.address_string
    var location_city = "" // Will be feeded during geocoding and sent to events table
    
    //debug
    sport = "sailing"
    organizer_id = "debug_organizer_id2"
    price = 5
    part_max = 10
    date = "2019-11-02"
    addressStr = "24 Rue Rameau Clermont Ferrand"
	
    var colTarget = "(event_id,date,sport,nb_part_sub,nb_part_max,price_per_part,organizer_id,latitude,longitude,country,city,street_name,street_number)"

    //console.log("Collected from the client:",sport,organizer_id,price,part_max,date,addressStr,location_city)
    
    // Generate the event_id
    var dt = datetime.create();
    var dt = dt.format('Y_m')
    var eventID = dt + '_E_' + rdmString.generate(40) ;
    
    // Geocoding closure to obtain geocoding data which will be saved in the db
    geocodeFunction(addressStr).then(dictGeoResult => {
    		
	var valToInsrt = [
	AddSimpleQuote(eventID),
	AddSimpleQuote(date),
	AddSimpleQuote(sport),
	AddSimpleQuote(0), // <-- nb-part-sub = 0
	AddSimpleQuote(part_max),
	AddSimpleQuote(price),
	AddSimpleQuote(organizer_id),
	AddSimpleQuote(dictGeoResult.latitude),
	AddSimpleQuote(dictGeoResult.longitude),
	AddSimpleQuote(dictGeoResult.state),
	AddSimpleQuote(dictGeoResult.city),
	AddSimpleQuote(dictGeoResult.street),
	AddSimpleQuote(dictGeoResult.number)
	]
	
	
	/*var trgetQuery = "INSERT INTO 2019_" + country_code_table + " " + colTarget + " VALUES (" + valToInsrt + " )"
	promiseBasicQuery(trgetQuery).then(QueryResult => {
		
		res.status(200).send("OK")
		
	})	//BasicQuery
	*/
	

	DBInsert("2019_fr",colTarget,valToInsrt).then(QueryResult => {
	console.log(QueryResult)
	})
		
		
		
	}) // geocoding
	
}); // createevent

function CollectEvents(countryCode) {

	return new Promise (function(resolve,reject) {

		PrepareAndQuery(countryCode).then(rawResult => {
		resolve(rawResult)
		})
	})

}

function PrepareAndQuery(countryCode) {

	return new Promise(function(resolve,reject) {
	
		var strQuery = "SELECT * from 2019_" + countryCode
		promiseBasicQuery(strQuery).then(rawRows => {
		resolve(rawRows)
		})
	
	})
}

// ================ SERVER LAUNCH ======================
// Helper on port 3002
app.listen(3002,function(req,res){
    console.log('WORKS DATES ON GOING');
});

// =================== DATABASES FUNCTIONS ==============================

function promiseBasicQuery(query) {

	return new Promise(function(resolve,reject) {
		
		pool_events.getConnection(function (err,con) {
			if (err) {
				console.log(err)
			} else {
				console.log("Check connection : OK")
			con.query(query, function(err,result,fields) {	
					if (err) {
						return reject(err)
						console.log(err)
					} else {
						return resolve(result)
					}

					})
			
			}
			con.release();
		})

	})
}

function checkEventsInTheTable(elem) {

	return new Promise(function(resolve,reject) {
		
	    // PRELIMINARY WORKS
	    var collected_events = [] 
	    var organizer_id = "'debug_organizer_id_1'"
	    
	    var selec_query = "SELECT * FROM " + elem + " WHERE organizer_id = " + organizer_id

	    promiseBasicQuery(selec_query).then(results => {
	    resolve(results)
	    });

	})
				    
}

function AddSimpleQuote(elem) {	

	return ("'" + elem + "'")
}

// GEOCODING
function geocodeFunction(userRequest) {
	
	return new Promise(function(resolve,reject) {
	
	//on recupere juste le numero de maison car pb en geocoding
    var splitted = userRequest.split(" ");
    var resNumberHome = splitted[0];

		geocoder.geocode(userRequest, function(err,res) {

			// RETURNED RESPONSE IS AN ARRAY WITH ONE JSON OBJECT
			var resArray = res[0];

			//console.log(resArray)
		
			// SELECT OUR KEYS
			var resStreet = resArray.streetName;
			var resCity = resArray.city;
			var resState = resArray.state;
			//console.log(resNumberHome,resStreet, resCity,resState);
		
			// SELECT LATITUDE & LONGITUDE
			var resLatitude = resArray.latitude;
			var resLongitude = resArray.longitude;

			var locationData = {
				"latitude": resLatitude.toString(),
				"longitude": resLongitude.toString() ,
				"state": resState ,
				"city": resCity,
				"street": resStreet,
				"number": resNumberHome.toString()
			}

			resolve(locationData);
			
		});
	
	}) // Promise
	
};

function DBSelectAll(inserts) {

	return new Promise(function(resolve,reject) {
		
		pool_events.getConnection(function (err,con) {
			
			if (err) {
				console.log(err)
				
			} else {
				
			console.log("Check connection : OK")
			var sql = "SELECT * FROM ?"
			
			con.format(sql,inserts, function(err,result,fields) {
					if (err) {
						return reject(err)
						console.log(err)
					} else {
						return resolve(result)
					}
			})
			
			}
			
		con.release();
		})

	})
}

function DBInsert(table,col,values) {

	return new Promise(function(resolve,reject) {
		
		pool_events.getConnection(function (err,con) {
			
			if (err) {
				console.log(err)
				
			} else {
				
			console.log("Check connection : OK")
			var sql = "INSERT INTO ? (?) VALUES (?)"
			var inserts = [table,col,values]
			console.log(inserts)
			con.format(sql,inserts, function(err,result,fields) {
					if (err) {
						return reject(err)
						console.log(err)
					} else {
						return resolve(result)
					}
			})
			
			}
			
		con.release();
		})

	})
}

